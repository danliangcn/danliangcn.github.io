<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-07-11 四 16:56 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Logistic回归</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="厦门大学公共事务学院" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Logistic回归</h1>

<div id="outline-container-org7b0f99b" class="outline-2">
<h2 id="org7b0f99b"><span class="section-number-2">1</span> 单个预测变量的logistic回归</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3bf3aff" class="outline-3">
<h3 id="org3bf3aff"><span class="section-number-3">1.1</span> 通过收入解释政治偏好</h3>
<div class="outline-text-3" id="text-1-1">
<p>
1992年美国大选<a href="./nescleaned.RData">民调数据</a>，对于选民i，如果 \(y_i=1\) ，那么他会选布什，如果 \(y_i=0\) ，那么他会选克林顿，通过收入（5个收入等级）来预测选民的政治偏好。  
logistic回归模型如下：
</p>
<div class="org-src-container">
<pre class="src src-R">nes <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #4f97d7;">load</span>(<span style="color: #2d9574;">"nescleaned.RData"</span>)
yr <span style="color: #ce537a; font-weight: bold;">&lt;-</span> 1992
ok <span style="color: #ce537a; font-weight: bold;">&lt;-</span> data$year==yr &amp; data$presvote&lt;3
vote <span style="color: #ce537a; font-weight: bold;">&lt;-</span> data$presvote[ok] - 1
income <span style="color: #ce537a; font-weight: bold;">&lt;-</span> data$income[ok]
fit.1 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (vote ~ income, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.1)
result <span style="color: #ce537a; font-weight: bold;">&lt;-</span> summary(fit.1)
round(result$coefficients, digits=2)
</pre>
</div>

<pre class="example">

Call:
glm(formula = vote ~ income, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.2756  -1.0034  -0.8796   1.2194   1.6550  

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -1.40213    0.18946  -7.401 1.35e-13 ***
income       0.32599    0.05688   5.731 9.97e-09 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1591.2  on 1178  degrees of freedom
Residual deviance: 1556.9  on 1177  degrees of freedom
  (368 observations deleted due to missingness)
AIC: 1560.9

Number of Fisher Scoring iterations: 4

            Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)    -1.40       0.19   -7.40        0
income          0.33       0.06    5.73        0
</pre>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #bc6ec5; font-weight: bold;">invlogit</span> <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span>(x){
  p <span style="color: #ce537a; font-weight: bold;">&lt;-</span> exp(x)/(1+exp(x))
  <span style="color: #4f97d7; font-weight: bold;">return</span>(p)
}
<span style="color: #4f97d7;">par</span>(mfrow=c(1,2))
curve (invlogit(fit.1$coef[1] + fit.1$coef[2]*x), 1, 5, ylim=c(-.01,1.01),
       xlim=c(-2,8), xaxt=<span style="color: #2d9574;">"n"</span>, xaxs=<span style="color: #2d9574;">"i"</span>, mgp=c(2,.5,0),
       ylab=<span style="color: #2d9574;">"Pr (Republican vote)"</span>, xlab=<span style="color: #2d9574;">"Income"</span>, lwd=4)
curve (invlogit(fit.1$coef[1] + fit.1$coef[2]*x), -2, 8, lwd=.5, add=T)
axis (1, 1:5, mgp=c(2,.5,0))
mtext (<span style="color: #2d9574;">"(poor)"</span>, 1, 1.5, at=1, adj=.5)
mtext (<span style="color: #2d9574;">"(rich)"</span>, 1, 1.5, at=5, adj=.5)
points (jitter (income, .5), jitter (vote, .08), pch=20, cex=.1)

<span style="color: #2aa1ae; background-color: #292e34;">##</span><span style="color: #2aa1ae; background-color: #292e34;">&#27169;&#25311;&#22238;&#24402;&#31995;&#25968;&#30340;&#20989;&#25968;</span>
<span style="color: #bc6ec5; font-weight: bold;">sim</span> <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span>(fit, n.sims=100)
{
  summ <span style="color: #ce537a; font-weight: bold;">&lt;-</span> summary (fit, correlation=<span style="color: #a45bad;">TRUE</span>, dispersion = fit$dispersion)
  coef <span style="color: #ce537a; font-weight: bold;">&lt;-</span> summ$coef[,1:2,drop=<span style="color: #a45bad;">FALSE</span>]
  dimnames(coef)[[2]] <span style="color: #ce537a; font-weight: bold;">&lt;-</span> c(<span style="color: #2d9574;">"coef.est"</span>,<span style="color: #2d9574;">"coef.sd"</span>)
  beta.hat <span style="color: #ce537a; font-weight: bold;">&lt;-</span> coef[,1,drop=<span style="color: #a45bad;">FALSE</span>]
  sd.beta <span style="color: #ce537a; font-weight: bold;">&lt;-</span> coef[,2,drop=<span style="color: #a45bad;">FALSE</span>]
  corr.beta <span style="color: #ce537a; font-weight: bold;">&lt;-</span> summ$corr
  n <span style="color: #ce537a; font-weight: bold;">&lt;-</span> summ$df[1] + summ$df[2]
  k <span style="color: #ce537a; font-weight: bold;">&lt;-</span> summ$df[1]
  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462;&#22238;&#24402;&#31995;&#25968;&#30340;&#21327;&#26041;&#24046;&#30697;&#38453;</span>
  V.beta <span style="color: #ce537a; font-weight: bold;">&lt;-</span> corr.beta * array(sd.beta,c(k,k)) * t(array(sd.beta,c(k,k)))
  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#20197;&#20272;&#35745;&#30340;&#21442;&#25968;&#26500;&#24314;&#22810;&#20803;&#27491;&#24577;&#20998;&#24067;&#65292;&#24182;&#20174;&#20013;&#25277;&#21462;&#27169;&#25311;&#30340;&#21442;&#25968;</span>
  beta <span style="color: #ce537a; font-weight: bold;">&lt;-</span> MASS::mvrnorm (n.sims, beta.hat, V.beta)
  sigma <span style="color: #ce537a; font-weight: bold;">&lt;-</span> rep (sqrt(summ$dispersion), n.sims)

  ans <span style="color: #ce537a; font-weight: bold;">&lt;-</span> list(coef = beta, sigma = sigma)
  <span style="color: #4f97d7; font-weight: bold;">return</span>(ans)
}

sim.1 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> sim(fit.1)
curve (invlogit(fit.1$coef[1] + fit.1$coef[2]*x), .5, 5.5, ylim=c(-.01,1.01),
       xlim=c(.5,5.5), xaxt=<span style="color: #2d9574;">"n"</span>, xaxs=<span style="color: #2d9574;">"i"</span>, mgp=c(2,.5,0),
       ylab=<span style="color: #2d9574;">"Pr (Republican vote)"</span>, xlab=<span style="color: #2d9574;">"Income"</span>, lwd=1)
<span style="color: #4f97d7; font-weight: bold;">for</span> (j <span style="color: #4f97d7; font-weight: bold;">in</span> 1:20){
  curve (invlogit(sim.1$coef[j,1] + sim.1$coef[j,2]*x), col=<span style="color: #2d9574;">"gray"</span>, lwd=.5, add=T)
}
curve (invlogit(fit.1$coef[1] + fit.1$coef[2]*x), add=T)
axis (1, 1:5, mgp=c(2,.5,0))
mtext (<span style="color: #2d9574;">"(poor)"</span>, 1, 1.5, at=1, adj=.5)
mtext (<span style="color: #2d9574;">"(rich)"</span>, 1, 1.5, at=5, adj=.5)
points (jitter (income, .5), jitter (vote, .08), pch=20, cex=.1)
</pre>
</div>


<div class="figure">
<p><img src="election1.png" alt="election1.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgbdb13f3" class="outline-3">
<h3 id="orgbdb13f3"><span class="section-number-3">1.2</span> logistic回归模型</h3>
<div class="outline-text-3" id="text-1-2">
<p>
\[Pr(y_i=1)=logit^{-1}(X_i\beta)\]
函数 \(logit^{-1}(x)=\frac{e^x}{1+e^x}\) 将连续数值转化为0到1之间的数。  
</p>

<p>
模型等同于 \(Pr(y_i=1)=p_i\) 和 \(logit(p_i)=X_i\beta\) ，其中 \(logit(x)=log(x/(1-x))\)  
</p>

<p>
logit反函数是曲线形式的，因此对于x的变化，y的变化不会是常量。  
</p>

<ul class="org-ul">
<li>\(logit(0.5)=0\), \(logit(0.6)=0.4\) ，意味着logit值增加0.4，相应的概率从50%增加到60%</li>

<li>\(logit(0.9)=2.2\) , \(logit(0.93)=2.6\) ，则意味着logit值增加0.4，相应的概率从90%增加到93%</li>
</ul>
</div>
</div>

<div id="outline-container-org9475e05" class="outline-3">
<h3 id="org9475e05"><span class="section-number-3">1.3</span> logistic回归系数的解释</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>由于非线性模型，系数解释比较复杂</li>
</ul>
<p>
\[Pr(支持布什)=logit^{-1}(-1.4+0.33\cdot income)\]
<b>针对数据均值进行评价:</b>
 具有平均收入水平选民支持布什的概率: 40.5%
</p>
<div class="org-src-container">
<pre class="src src-R">invlogit(-1.40 + 0.33*mean(income, na.rm=T))
</pre>
</div>

<pre class="example">
[1] 0.4049001

</pre>

<ul class="org-ul">
<li>收入水平变化1个等级所产生的概率变化</li>
</ul>
<p>
\[logit^{-1}(-1.4+0.33\cdot 3)-logit^{-1}(-1.4+0.33\cdot 2)=0.08\]
也可以计算logit反函数曲线在中心值处的斜率
\[logit^{-1}(\alpha +\beta x)的导数: \frac{\beta e^{\alpha +\beta x}}{(1+e^{\alpha +\beta x})^2}，带入\bar{x}=3.1，得到\frac{0.33e^{-0.39}}{(1+e^{-0.39})^2}=0.13\]
</p>

<ul class="org-ul">
<li>除4法则</li>
</ul>
<p>
logit反函数曲线在中心位置斜率最大，此时 \(\alpha +\beta x=0\) ，因此 \(logit^{-1}(\alpha +\beta x)=0.5\) ，并且函数的导数也在此点最大，且为 \(\beta e^0 /(1+e^0)^2=\beta /4\) ，它是收入改变1个单位引起概率变化的最大值。  
</p>

<ul class="org-ul">
<li>推断  
<ul class="org-ul">
<li>系数的估计量与标准差：采用最大似然法估计，统计显著性与线性回归相似</li>
<li>预测：logit回归预测概率，对于还未观测的 \(\tilde y_i\) ，其概率为 \(\tilde p_i=Pr(\tilde y_i=1)=logit^{-1}(\tilde X_i\beta)\)</li>
</ul></li>

<li>模型拟合与展示</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">plot (income, vote)
curve(invlogit(coef(fit.1)[1] + coef(fit.1)[2]*x),add = <span style="color: #a45bad;">TRUE</span>)
</pre>
</div>


<div class="figure">
<p><img src="election2.png" alt="election2.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orge73aaaa" class="outline-3">
<h3 id="orge73aaaa"><span class="section-number-3">1.4</span> 展示多个logistic回归的结果</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>采用1952-2000年的13届选前民调回归，收入系数的估计值 \(\pm 1\) 标准差，显示高收入选民更支持共和党，但是这种关系随着时间的推移越来越强。</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">income.year <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #a45bad;">NULL</span>
income.coef <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #a45bad;">NULL</span>
income.se <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #a45bad;">NULL</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> (yr <span style="color: #4f97d7; font-weight: bold;">in</span> seq(1952,2000,4)){
  ok <span style="color: #ce537a; font-weight: bold;">&lt;-</span> data$year==yr &amp; data$presvote&lt;3
  vote <span style="color: #ce537a; font-weight: bold;">&lt;-</span> data$presvote[ok] - 1
  income <span style="color: #ce537a; font-weight: bold;">&lt;-</span> data$income[ok]
  fit.1 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (vote ~ income, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
  income.year <span style="color: #ce537a; font-weight: bold;">&lt;-</span> c (income.year, yr)
  summ <span style="color: #ce537a; font-weight: bold;">&lt;-</span> summary(fit.1)
  income.coef <span style="color: #ce537a; font-weight: bold;">&lt;-</span> c (income.coef, fit.1$coef[2])
  income.se <span style="color: #ce537a; font-weight: bold;">&lt;-</span> c (income.se, summ$coefficients[2,2])
}

plot (income.year, income.coef, xlim=c(1950,2000), ylim=range(income.coef+income.se, 
                                                              income.coef-income.se), mgp=c(2,.5,0), pch=20, ylab=<span style="color: #2d9574;">"Coefficient of income"</span>, xlab=<span style="color: #2d9574;">"Year"</span>)
<span style="color: #4f97d7; font-weight: bold;">for</span> (i <span style="color: #4f97d7; font-weight: bold;">in</span> 1:length(income.year)){
  lines (rep(income.year[i],2), income.coef[i]+income.se[i]*c(-1,1), lwd=.5)
}
abline (0,0,lwd=.5, lty=2)

</pre>
</div>


<div class="figure">
<p><img src="election3.png" alt="election3.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgd6ca568" class="outline-3">
<h3 id="orgd6ca568"><span class="section-number-3">1.5</span> 利用潜在变量构建回归模型</h3>
<div class="outline-text-3" id="text-1-5">
<p>
\[\begin{equation}
    y_i=
\begin{cases} 1 & \text{if } z_i >0 \\ 0 & \text{if } z_i <0
\end{cases}\\
z_i=X_i\beta+\epsilon_i
\end{equation}\]
其中独立误差项 \(\epsilon_i\) 具有logistic概率分布， \(Pr(\epsilon_i < x)=logit^{-1}(x)\)  
\[Pr(y_i=1)=Pr(z_i>0)=Pr(\epsilon_i>-X_i\beta)=logit^{-1}(X_i\beta)\]
 潜在变量也可以解释为选民的对布什的“效用”和偏好。  
 潜在变量可以用正态回归模型近似 \(z_i=X_i\beta+\epsilon_i , ~ \epsilon_i \sim N(0,\sigma^2) ~ with~ \sigma=1.6\)，由于潜在变量符号与大小无关，因此无法估计 \(\epsilon\)
</p>
<div class="org-src-container">
<pre class="src src-R">curve(dlogis(x,location = -1.07),-9,7,yaxs=<span style="color: #2d9574;">'i'</span>)
polygon(x=c(0,seq(0,7,0.01),7),y=c(0,dlogis(seq(0,7,0.01),location = -1.07),0),col = <span style="color: #2d9574;">"gray"</span>)
</pre>
</div>


<div class="figure">
<p><img src="demologis.png" alt="demologis.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org3c1d586" class="outline-3">
<h3 id="org3c1d586"><span class="section-number-3">1.6</span> logistic回归模型示例：孟加拉居民水井砷污染 <a href="./wells.dat">数据</a></h3>
<div class="outline-text-3" id="text-1-6">

<div class="figure">
<p><img src="./image1.jpg" alt="image1.jpg" width="800" />
</p>
</div>
</div>

<ol class="org-ol">
<li><a id="org71cade6"></a>分析居民改换饮用水井的行为<br />
<div class="outline-text-4" id="text-1-6-1">
<p>
\(y_i=1\) 居民改换新的饮用水井;  \(y_i=0\) 居民继续用自家的井.
 输入变量
</p>
<ul class="org-ul">
<li>常数项</li>
<li>离最近安全水井的距离（米）</li>
<li>自家井水中的砷浓度水平</li>
<li>家庭成员是否积极参与社区组织</li>
<li>户主的教育水平</li>
</ul>
</div>
</li>

<li><a id="orgb09418c"></a>单预测变量logistic回归<br />
<div class="outline-text-4" id="text-1-6-2">
<div class="org-src-container">
<pre class="src src-R">wells <span style="color: #ce537a; font-weight: bold;">&lt;-</span> read.table (<span style="color: #2d9574;">"wells.dat"</span>)
<span style="color: #4f97d7;">attach</span>(wells)
fit.1 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ dist, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary (fit.1)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ dist, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.4406  -1.3058   0.9669   1.0308   1.6603  

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  0.6059594  0.0603102  10.047  &lt; 2e-16 ***
dist        -0.0062188  0.0009743  -6.383 1.74e-10 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 4076.2  on 3018  degrees of freedom
AIC: 4080.2

Number of Fisher Scoring iterations: 4
</pre>

<ul class="org-ul">
<li>改变预测变量的单位（以100米为单位）</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">dist100 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> dist/100
fit.2 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ dist100, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.2)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ dist100, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.4406  -1.3058   0.9669   1.0308   1.6603  

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  0.60596    0.06031  10.047  &lt; 2e-16 ***
dist100     -0.62188    0.09743  -6.383 1.74e-10 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 4076.2  on 3018  degrees of freedom
AIC: 4080.2

Number of Fisher Scoring iterations: 4
</pre>

<ul class="org-ul">
<li>绘制拟合模型</li>
</ul>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #bc6ec5; font-weight: bold;">jitter.binary</span> <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span>(a, jitt=.05){
  ifelse (a==0, runif (length(a), 0, jitt), runif (length(a), 1-jitt, 1))
}

switch.jitter <span style="color: #ce537a; font-weight: bold;">&lt;-</span> jitter.binary(switch)

plot(dist, switch.jitter, xlab=<span style="color: #2d9574;">"Distance (in meters) to nearest safe well"</span>, ylab=<span style="color: #2d9574;">"Pr (switching)"</span>, type=<span style="color: #2d9574;">"n"</span>, xaxs=<span style="color: #2d9574;">"i"</span>, yaxs=<span style="color: #2d9574;">"i"</span>, mgp=c(2,.5,0))
curve (invlogit(coef(fit.1)[1]+coef(fit.1)[2]*x), lwd=1, add=<span style="color: #a45bad;">TRUE</span>)
points (dist, jitter.binary(switch), pch=20, cex=.1)
</pre>
</div>


<div class="figure">
<p><img src="well1.png" alt="well1.png" />
</p>
</div>

<ul class="org-ul">
<li>解释logistic回归的系数</li>
</ul>

<p>
\[Pr(switch)=logit^{-1}(0.61-0.62\cdot dist100)\]
</p>
<ol class="org-ol">
<li>常数项：当 \(dist100=0\) 时，换水井的概率为 \(logit^{-1}(0.61)=0.65\)</li>

<li>在距离的平均值处预测距离增加引起的概率变化，以100米为单位的距离平均值为0.48，此处线性预测部分为 \(0.61-0.62\cdot 0.48=0.31\) ，此处的曲线斜率为 \(-0.62e^{0.31}/(1+e^{0.31})^2=-0.15\) ，即距安全饮用水井距离增加100米，换水井的概率下降15%</li>

<li>更快的方法：除4法则 \(-0.62/4=-0.15\)</li>

<li>标准差为0.10，95%的置信区间[-0.82, -0.42]</li>
</ol>
</div>
</li>

<li><a id="orge601be0"></a>增加第二个变量（砷的浓度水平）<br />
<div class="outline-text-4" id="text-1-6-3">
<div class="org-src-container">
<pre class="src src-R">fit.3 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ dist100 + arsenic, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.3)
<span style="color: #4f97d7;">par</span>(mfrow=c(1,2))
plot(dist, switch.jitter, xlim=c(0,max(dist)), xlab=<span style="color: #2d9574;">"Distance (in meters) to nearest safe well"</span>, ylab=<span style="color: #2d9574;">"Pr (switching)"</span>, type=<span style="color: #2d9574;">"n"</span>, xaxs=<span style="color: #2d9574;">"i"</span>, yaxs=<span style="color: #2d9574;">"i"</span>, mgp=c(2,.5,0))
curve (invlogit(cbind (1, x/100, .5) <span style="color: #7590db;">%*%</span> coef(fit.3)), lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
curve (invlogit(cbind (1, x/100, 1.0) <span style="color: #7590db;">%*%</span> coef(fit.3)), lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
points (dist, jitter.binary(switch), pch=20, cex=.1)
text (50, .27, <span style="color: #2d9574;">"if As = 0.5"</span>, adj=0, cex=.8)
text (75, .50, <span style="color: #2d9574;">"if As = 1.0"</span>, adj=0, cex=.8)

plot(arsenic, switch.jitter, xlim=c(0,max(arsenic)), xlab=<span style="color: #2d9574;">"Arsenic concentration in well water"</span>, ylab=<span style="color: #2d9574;">"Pr (switching)"</span>, type=<span style="color: #2d9574;">"n"</span>, xaxs=<span style="color: #2d9574;">"i"</span>, yaxs=<span style="color: #2d9574;">"i"</span>, mgp=c(2,.5,0))
curve (invlogit(cbind (1, 0, x) <span style="color: #7590db;">%*%</span> coef(fit.3)), lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
curve (invlogit(cbind (1, 0.5, x) <span style="color: #7590db;">%*%</span> coef(fit.3)), lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
points (arsenic, jitter.binary(switch), pch=20, cex=.1)
text (1.5, .78, <span style="color: #2d9574;">"if dist = 0"</span>, adj=0, cex=.8)
text (2.2, .6, <span style="color: #2d9574;">"if dist = 50"</span>, adj=0, cex=.8)
</pre>
</div>


<div class="figure">
<p><img src="well2.png" alt="well2.png" />
</p>
</div>
</div>
</li>

<li><a id="org14bfaa2"></a>如何解释和比较两个自变量的系数<br />
<div class="outline-text-4" id="text-1-6-4">
<ul class="org-ul">
<li>除4法则</li>

<li>距离和浓度哪个变量影响更大？
<ul class="org-ul">
<li>距离的标准差为0.38，增加1个标准差单位的距离产生的概率变化 \(-0.90\cdot 0.38/4=-8\%\)</li>
<li>浓度的标准差为1.10，增加1个标准差单位的浓度产生的概率变化 \(0.46\cdot 1.10/4=13\%\)</li>
</ul></li>
</ul>
<p>
加入浓度变量后，距离的系数由-0.62变为-0.90，因为离安全饮用水井较远的井的砷浓度也更高。（考虑增加交互项）
</p>
</div>
</li>

<li><a id="orgade8355"></a>含交互项的logistic回归<br />
<div class="outline-text-4" id="text-1-6-5">
<div class="org-src-container">
<pre class="src src-R">fit.4 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ dist100 + 
                arsenic + dist100:arsenic, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.4)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ dist100
arsenic
dist100:arsenic, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7823  -1.2004   0.7696   1.0816   1.8476  

Coefficients:
                Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)     -0.14787    0.11754  -1.258  0.20838    
dist100         -0.57722    0.20918  -2.759  0.00579 ** 
arsenic          0.55598    0.06932   8.021 1.05e-15 ***
dist100:arsenic -0.17891    0.10233  -1.748  0.08040 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 3927.6  on 3016  degrees of freedom
AIC: 3935.6

Number of Fisher Scoring iterations: 4
</pre>

<ul class="org-ul">
<li>解释系数
<ul class="org-ul">
<li>常数项：impossible! 采用距离均值0.48和浓度均值1.66可得 \(logit^{-1}(-0.15-0.58\cdot 0.48+0.56\cdot 1.66-0.18\cdot 0.48\cdot 1.66)=0.59\)</li>
<li>距离的系数：采用浓度取均值1.66时计算为 \(-0.58-0.18\cdot 1.66=-0.88\) ，然后 \(-0.88/4=-0.22\)</li>
<li>浓度的系数：可以用距离为0时解释，但是更常用平均距离</li>
</ul></li>
</ul>
<p>
浓度的系数为 \((0.56-0.18\cdot 0.48)/4=0.12\)  
</p>
<ul class="org-ul">
<li>交互项的系数：浓度每增加1个单位，距离的系数增加-0.18</li>
</ul>
</div>
</li>

<li><a id="org11afbff"></a>变量中心化后再拟合<br />
<div class="outline-text-4" id="text-1-6-6">
<div class="org-src-container">
<pre class="src src-R">c.dist100 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> dist100 - mean (dist100)
c.arsenic <span style="color: #ce537a; font-weight: bold;">&lt;-</span> arsenic - mean (arsenic)
fit.5 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ c.dist100 + c.arsenic + c.dist100:c.arsenic,
              family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.5)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ c.dist100
c.arsenic
c.dist100:c.arsenic, 
    family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7823  -1.2004   0.7696   1.0816   1.8476  

Coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          0.35109    0.03985   8.810   &lt;2e-16 ***
c.dist100           -0.87365    0.10480  -8.337   &lt;2e-16 ***
c.arsenic            0.46951    0.04207  11.159   &lt;2e-16 ***
c.dist100:c.arsenic -0.17891    0.10233  -1.748   0.0804 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 3927.6  on 3016  degrees of freedom
AIC: 3935.6

Number of Fisher Scoring iterations: 4
</pre>

<p>
<b>试解释各项系数</b>  
</p>
<ul class="org-ul">
<li>变量中心化便于直观地解释系数</li>
<li>交互项的显著性不强，但方向符合预期，保留。</li>
</ul>
</div>
</li>

<li><a id="org10753d0"></a>含有交互项模型示意图<br />
<div class="outline-text-4" id="text-1-6-7">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #4f97d7;">par</span>(mfrow=c(1,2))
plot(dist, switch.jitter, xlim=c(0,max(dist)), xlab=<span style="color: #2d9574;">"Distance (in meters) to nearest safe well"</span>, 
     ylab=<span style="color: #2d9574;">"Pr (switching)"</span>, type=<span style="color: #2d9574;">"n"</span>, xaxs=<span style="color: #2d9574;">"i"</span>, yaxs=<span style="color: #2d9574;">"i"</span>, mgp=c(2,.5,0))
curve (invlogit(cbind (1, x/100, .5, .5*x/100) <span style="color: #7590db;">%*%</span> coef(fit.4)), lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
curve (invlogit(cbind (1, x/100, 1.0, 1.0*x/100) <span style="color: #7590db;">%*%</span> coef(fit.4)), lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
points (dist, jitter.binary(switch), pch=20, cex=.1)
text (50, .37, <span style="color: #2d9574;">"if As = 0.5"</span>, adj=0, cex=.8)
text (75, .50, <span style="color: #2d9574;">"if As = 1.0"</span>, adj=0, cex=.8)

plot(arsenic, switch.jitter, xlim=c(0,max(arsenic)), xlab=<span style="color: #2d9574;">"Arsenic concentration in well water"</span>,
     ylab=<span style="color: #2d9574;">"Pr (switching)"</span>, type=<span style="color: #2d9574;">"n"</span>, xaxs=<span style="color: #2d9574;">"i"</span>, yaxs=<span style="color: #2d9574;">"i"</span>, mgp=c(2,.5,0))
curve (invlogit(cbind (1, 0, x, 0*x) <span style="color: #7590db;">%*%</span> coef(fit.4)), lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
curve (invlogit(cbind (1, 0.5, x, 0.5*x) <span style="color: #7590db;">%*%</span> coef(fit.4)), lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
points (arsenic, jitter.binary(switch), pch=20, cex=.1)
text (1.5, .8, <span style="color: #2d9574;">"if dist = 0"</span>, adj=0, cex=.8)
text (2.2, .6, <span style="color: #2d9574;">"if dist = 50"</span>, adj=0, cex=.8)
</pre>
</div>


<div class="figure">
<p><img src="well3.png" alt="well3.png" />
</p>
</div>
</div>
</li>

<li><a id="orga85b286"></a>增加社会性变量<br />
<div class="outline-text-4" id="text-1-6-8">
<p>
社会联系更紧密或者教育程度更高的居民是否会更倾向于改换饮用水井？  
</p>

<p>
如果家庭成员加入了任何社区组织，那么assoc=1；educ是户主的教育年限，为了便于解释系数，实际采用educ4=edu/4  
</p>
<div class="org-src-container">
<pre class="src src-R">educ4 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> educ/4
fit.6 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ c.dist100 + c.arsenic + c.dist100:c.arsenic +
                assoc + educ4, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.6)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ c.dist100
c.arsenic
c.dist100:c.arsenic

    assoc
educ4, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7303  -1.1892   0.7444   1.0675   1.6987  

Coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          0.20252    0.06930   2.922  0.00347 ** 
c.dist100           -0.87528    0.10507  -8.330  &lt; 2e-16 ***
c.arsenic            0.47531    0.04229  11.238  &lt; 2e-16 ***
assoc               -0.12319    0.07698  -1.600  0.10953    
educ4                0.16779    0.03838   4.372 1.23e-05 ***
c.dist100:c.arsenic -0.16123    0.10225  -1.577  0.11482    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 3905.4  on 3014  degrees of freedom
AIC: 3917.4

Number of Fisher Scoring iterations: 4
</pre>

<p>
解释系数，决定在模型中的变量取舍？
</p>
</div>
</li>

<li><a id="org64405b5"></a>拟合新的模型<br />
<div class="outline-text-4" id="text-1-6-9">
<div class="org-src-container">
<pre class="src src-R">fit.7 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ c.dist100 + c.arsenic + c.dist100:c.arsenic +
                educ4, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.7)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ c.dist100
c.arsenic
c.dist100:c.arsenic

    educ4, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7149  -1.1886   0.7478   1.0689   1.7223  

Coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          0.14844    0.06044   2.456   0.0141 *  
c.dist100           -0.87462    0.10510  -8.322  &lt; 2e-16 ***
c.arsenic            0.47663    0.04228  11.273  &lt; 2e-16 ***
educ4                0.16922    0.03833   4.415 1.01e-05 ***
c.dist100:c.arsenic -0.16291    0.10235  -1.592   0.1115    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 3907.9  on 3015  degrees of freedom
AIC: 3917.9

Number of Fisher Scoring iterations: 4
</pre>

<p>
如果主效应较大，还要考虑增加交互项
</p>
<div class="org-src-container">
<pre class="src src-R">c.educ4 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> educ4 - mean(educ4)

fit.8 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ c.dist100 + c.arsenic + c.educ4 + 
                c.dist100:c.arsenic + c.dist100:c.educ4 + 
                c.arsenic:c.educ4, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.8)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ c.dist100
c.arsenic
c.educ4
c.dist100:c.arsenic

    c.dist100:c.educ4
c.arsenic:c.educ4, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.5706  -1.1964   0.7314   1.0724   1.8712  

Coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          0.35630    0.04028   8.844  &lt; 2e-16 ***
c.dist100           -0.90286    0.10731  -8.414  &lt; 2e-16 ***
c.arsenic            0.49498    0.04305  11.497  &lt; 2e-16 ***
c.educ4              0.18498    0.03919   4.720 2.36e-06 ***
c.dist100:c.arsenic -0.11768    0.10353  -1.137  0.25569    
c.dist100:c.educ4    0.32269    0.10662   3.026  0.00247 ** 
c.arsenic:c.educ4    0.07223    0.04387   1.647  0.09965 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 3891.7  on 3013  degrees of freedom
AIC: 3905.7

Number of Fisher Scoring iterations: 4
</pre>

<p>
解释交互项？
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org840b746" class="outline-3">
<h3 id="org840b746"><span class="section-number-3">1.7</span> 检查与比较拟合的logistic回归</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li>残差与分箱残差</li>
</ul>
<p>
\[residual_i=y_i-E(y_i|X_i)=y_i-logit^{-1}(X_i\beta)\]
残差图提供不了有用的信息，因此采用拟合值将数据分到不同的类别（箱），然后绘制每个分箱的拟合值均值和残差均值  
</p>
<div class="org-src-container">
<pre class="src src-R">pred.8 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> fit.8$fitted.values

plot(c(0,1), c(-1,1), xlab=<span style="color: #2d9574;">"Estimated  Pr (switching)"</span>, ylab=<span style="color: #2d9574;">"Observed - estimated"</span>, type=<span style="color: #2d9574;">"n"</span>, main=<span style="color: #2d9574;">"Residual plot"</span>, mgp=c(2,.5,0))
abline (0,0, col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
points (pred.8, switch-pred.8, pch=20, cex=.2)

</pre>
</div>


<div class="figure">
<p><img src="well4.png" alt="well4.png" />
</p>
</div>

<ul class="org-ul">
<li>分箱残差图（Binned residual Plot）</li>
</ul>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">Defining binned residuals</span>

<span style="color: #bc6ec5; font-weight: bold;">binned.resids</span> <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span> (x, y, nclass=sqrt(length(x))){
  breaks.index <span style="color: #ce537a; font-weight: bold;">&lt;-</span> floor(length(x)*(1:(nclass-1))/nclass)
  breaks <span style="color: #ce537a; font-weight: bold;">&lt;-</span> c (-<span style="color: #a45bad;">Inf</span>, sort(x)[breaks.index], <span style="color: #a45bad;">Inf</span>)
  output <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #a45bad;">NULL</span>
  xbreaks <span style="color: #ce537a; font-weight: bold;">&lt;-</span> <span style="color: #a45bad;">NULL</span>
  x.binned <span style="color: #ce537a; font-weight: bold;">&lt;-</span> as.numeric (cut (x, breaks))
  <span style="color: #4f97d7; font-weight: bold;">for</span> (i <span style="color: #4f97d7; font-weight: bold;">in</span> 1:nclass){
    items <span style="color: #ce537a; font-weight: bold;">&lt;-</span> (1:length(x))[x.binned==i]
    x.range <span style="color: #ce537a; font-weight: bold;">&lt;-</span> range(x[items])
    xbar <span style="color: #ce537a; font-weight: bold;">&lt;-</span> mean(x[items])
    ybar <span style="color: #ce537a; font-weight: bold;">&lt;-</span> mean(y[items])
    n <span style="color: #ce537a; font-weight: bold;">&lt;-</span> length(items)
    sdev <span style="color: #ce537a; font-weight: bold;">&lt;-</span> sd(y[items])
    output <span style="color: #ce537a; font-weight: bold;">&lt;-</span> rbind (output, c(xbar, ybar, n, x.range, 2*sdev/sqrt(n)))
  }
  colnames (output) <span style="color: #ce537a; font-weight: bold;">&lt;-</span> c (<span style="color: #2d9574;">"xbar"</span>, <span style="color: #2d9574;">"ybar"</span>, <span style="color: #2d9574;">"n"</span>, <span style="color: #2d9574;">"x.lo"</span>, <span style="color: #2d9574;">"x.hi"</span>, <span style="color: #2d9574;">"2se"</span>)
  <span style="color: #4f97d7; font-weight: bold;">return</span> (list (binned=output, xbreaks=xbreaks))
}

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">Binned residuals vs. estimated probability of switching</span>

br.8 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> binned.resids (pred.8, switch-pred.8, nclass=40)$binned
plot(range(br.8[,1]), range(br.8[,2],br.8[,6],-br.8[,6]), xlab=<span style="color: #2d9574;">"Estimated  Pr (switching)"</span>, ylab=<span style="color: #2d9574;">"Average residual"</span>, type=<span style="color: #2d9574;">"n"</span>, main=<span style="color: #2d9574;">"Binned residual plot"</span>, mgp=c(2,.5,0))
abline (0,0, col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
lines (br.8[,1], br.8[,6], col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
lines (br.8[,1], -br.8[,6], col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
points (br.8[,1], br.8[,2], pch=19, cex=.5)

</pre>
</div>


<div class="figure">
<p><img src="well4-1.png" alt="well4-1.png" />
</p>
</div>

<ul class="org-ul">
<li>分箱残差与输入变量
<ul class="org-ul">
<li>距离-分箱残差图</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-R">br.dist <span style="color: #ce537a; font-weight: bold;">&lt;-</span> binned.resids (dist, switch-pred.8, nclass=40)$binned
plot(range(br.dist[,1]), range(br.dist[,2],br.dist[,6],-br.dist[,6]), xlab=<span style="color: #2d9574;">"Distance to nearest safe well"</span>, ylab=<span style="color: #2d9574;">"Average residual"</span>, type=<span style="color: #2d9574;">"n"</span>, main=<span style="color: #2d9574;">"Binned residual plot"</span>, mgp=c(2,.5,0))
abline (0,0, col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
lines (br.dist[,1], br.dist[,6], col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
lines (br.dist[,1], -br.dist[,6], col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
points (br.dist[,1], br.dist[,2], pch=19, cex=.5)
</pre>
</div>


<div class="figure">
<p><img src="well5.png" alt="well5.png" />
</p>
</div>

<ul class="org-ul">
<li>浓度-分箱残差图</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">br.arsenic <span style="color: #ce537a; font-weight: bold;">&lt;-</span> binned.resids (arsenic, switch-pred.8, nclass=40)$binned
plot(range(0,br.arsenic[,1]), range(br.arsenic[,2],br.arsenic[,6],-br.arsenic[,6]), xlab=<span style="color: #2d9574;">"Arsenic level"</span>, ylab=<span style="color: #2d9574;">"Average residual"</span>, type=<span style="color: #2d9574;">"n"</span>, main=<span style="color: #2d9574;">"Binned residual plot"</span>, mgp=c(2,.5,0))
abline (0,0, col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
lines (br.arsenic[,1], br.arsenic[,6], col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
lines (br.arsenic[,1], -br.arsenic[,6], col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
points (br.arsenic[,1], br.arsenic[,2], pch=19, cex=.5)
</pre>
</div>


<div class="figure">
<p><img src="well5-1.png" alt="well5-1.png" />
</p>
</div>

<p>
浓度与分箱残差图显示前3个分箱的残差均为较大的负值，说明预测值偏大，低浓度水井的居民不愿转换水井。
</p>

<p>
浓度与分箱残差图还显示中部的残差正值比较多，尾部的残差负值比较多，可考虑对数化。
</p>
<ul class="org-ul">
<li>对数变换</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">log.arsenic <span style="color: #ce537a; font-weight: bold;">&lt;-</span> log (arsenic)
c.log.arsenic <span style="color: #ce537a; font-weight: bold;">&lt;-</span> log.arsenic - mean (log.arsenic)
fit.9 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ c.dist100 + c.log.arsenic + c.educ4 +
                c.dist100:c.log.arsenic + c.dist100:c.educ4 + c.log.arsenic:c.educ4,
              family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.9)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ c.dist100
c.log.arsenic
c.educ4

    c.dist100:c.log.arsenic
c.dist100:c.educ4
c.log.arsenic:c.educ4, 
    family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.1034  -1.1623   0.7178   1.0400   1.9229  

Coefficients:
                        Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)              0.34517    0.04048   8.528  &lt; 2e-16 ***
c.dist100               -0.97956    0.11120  -8.809  &lt; 2e-16 ***
c.log.arsenic            0.90356    0.06951  12.999  &lt; 2e-16 ***
c.educ4                  0.17850    0.03900   4.577 4.71e-06 ***
c.dist100:c.log.arsenic -0.15670    0.18515  -0.846  0.39735    
c.dist100:c.educ4        0.33843    0.10776   3.141  0.00169 ** 
c.log.arsenic:c.educ4    0.06011    0.07030   0.855  0.39257    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 3863.1  on 3013  degrees of freedom
AIC: 3877.1

Number of Fisher Scoring iterations: 4
</pre>

<p>
比较拟合的logistic回归
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #4f97d7;">par</span>(mfrow=c(1,2))

fit.9a <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ dist100 + log.arsenic + educ4 +
                 dist100:log.arsenic + dist100:educ4 + log.arsenic:educ4,
               family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">Graph for log model fit.9a </span>

plot(arsenic, switch.jitter, xlim=c(0,max(arsenic)), xlab=<span style="color: #2d9574;">"Arsenic concentration in well water"</span>, ylab=<span style="color: #2d9574;">"Pr (switching)"</span>, type=<span style="color: #2d9574;">"n"</span>, xaxs=<span style="color: #2d9574;">"i"</span>, yaxs=<span style="color: #2d9574;">"i"</span>, mgp=c(2,.5,0))
curve (invlogit(coef(fit.9a)[1]+coef(fit.9a)[2]*0+coef(fit.9a)[3]*log(x)+coef(fit.9a)[4]*mean(educ4)+coef(fit.9a)[5]*0*log(x)+coef(fit.9a)[6]*0*mean(educ4)+coef(fit.9a)[7]*log(x)*mean(educ4)), from=.50, lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
curve (invlogit(coef(fit.9a)[1]+coef(fit.9a)[2]*.5+coef(fit.9a)[3]*log(x)+coef(fit.9a)[4]*mean(educ4)+coef(fit.9a)[5]*.5*log(x)+coef(fit.9a)[6]*.5*mean(educ4)+coef(fit.9a)[7]*log(x)*mean(educ4)), from=.50, lwd=.5, add=<span style="color: #a45bad;">TRUE</span>)
points (arsenic, jitter.binary(switch), pch=20, cex=.1)
text (1.2, .8, <span style="color: #2d9574;">"if dist = 0"</span>, adj=0, cex=.8)
text (1.8, .6, <span style="color: #2d9574;">"if dist = 50"</span>, adj=0, cex=.8)

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">Graph of binned residuals for log model fit.9</span>

pred.9 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> fit.9$fitted.values

br.fit.9 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> binned.resids (arsenic, switch-pred.9, nclass=40)$binned
plot(range(0,br.fit.9[,1]), range(br.fit.9[,2],br.fit.9[,6],-br.fit.9[,6]), xlab=<span style="color: #2d9574;">"Arsenic level"</span>, ylab=<span style="color: #2d9574;">"Average residual"</span>, type=<span style="color: #2d9574;">"n"</span>, main=<span style="color: #2d9574;">"Binned residual plot\nfor model with log (arsenic)"</span>, mgp=c(2,.5,0))
abline (0,0, col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
lines (br.fit.9[,1], br.fit.9[,6], col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
lines (br.fit.9[,1], -br.fit.9[,6], col=<span style="color: #2d9574;">"gray"</span>, lwd=.5)
points (br.fit.9[,1], br.fit.9[,2], pch=19, cex=.5)
</pre>
</div>


<div class="figure">
<p><img src="well6.png" alt="well6.png" />
</p>
</div>

<ul class="org-ul">
<li>拟合曲线图相似，在低浓度区域更陡，高浓度区域更平缓。</li>
<li>分箱残差图比较正常，但仍然第1个分箱的残差明显偏低，可能存在0.5的心理阈值或测量误差。</li>
</ul>
</div>
</div>

<div id="outline-container-org5e63fda" class="outline-3">
<h3 id="org5e63fda"><span class="section-number-3">1.8</span> 评价logistic回归</h3>
<div class="outline-text-3" id="text-1-8">
<p>
错误率（error rate）
</p>
<ul class="org-ul">
<li>无模型错误率为42%（58%的居民改换水井，42%的居民没有改换），当前模型错误率为36%</li>
<li>错误率无法区分拟合值0.6和0.9之间的区别</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">error.rate <span style="color: #ce537a; font-weight: bold;">&lt;-</span> mean((pred.9&gt;0.5 &amp; switch==0) | (pred.9&lt;0.5 &amp; switch==1))
error.rate
</pre>
</div>

<pre class="example">

[1] 0.3649007

</pre>

<p>
偏差（deviance）  
</p>
<ul class="org-ul">
<li>偏差值来度量错误，值越低说明拟合度越好</li>
<li>如果在模型中加入一个随机噪声的预测变量，平均而言偏差值只会减少1</li>
<li>如果加入一个具有信息量的预测变量，偏差值的减少会大于1；加入k个变量，则偏差值减少大于k</li>
<li>偏差值可以类比于线性回归中的 \(R^2\) ，其值来自于-2乘以似然函数的对数，应用时比较相对值即可</li>
</ul>

<p>
<b><b>比较之前拟合模型的偏差?</b></b>
</p>
</div>
</div>

<div id="outline-container-org43996b8" class="outline-3">
<h3 id="org43996b8"><span class="section-number-3">1.9</span> 比较多个自变量的平均效应</h3>
<div class="outline-text-3" id="text-1-9">
<p>
采用一个简单的模型来演示
</p>
<div class="org-src-container">
<pre class="src src-R">fit.10 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ dist100 + arsenic + educ4,
               family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.10)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ dist100
arsenic
educ4, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.5768  -1.1968   0.7554   1.0635   1.6990  

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -0.21393    0.09311  -2.298   0.0216 *  
dist100     -0.89564    0.10461  -8.562  &lt; 2e-16 ***
arsenic      0.46836    0.04159  11.261  &lt; 2e-16 ***
educ4        0.17128    0.03830   4.472 7.74e-06 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 3910.4  on 3016  degrees of freedom
AIC: 3918.4

Number of Fisher Scoring iterations: 4
</pre>

<p>
 比较距离安全饮用水井为0和100米的居民转换概率的平均预测差异    
\[\delta(arsenic,educ4)=logit^{-1}(-0.21-0.90\cdot 1+0.47\cdot arsenic+0.17\cdot educ4)\\ -logit^{-1}(-0.21-0.90\cdot 0+0.47\cdot arsenic+0.17\cdot educ4)\]
\[平均预测差异=\frac{1}{n}\sum_{i=1}^n \delta (arsenic_i,educ4_i)\]
结果为-0.20，现有数据而言，在砷浓度与教育水平相等的情况下，距安全饮用水井100米的居民比紧邻安全饮用水井的居民改换水井的概率平均要低20%.
</p>

<p>
含有交互项的模型的平均预测差异
</p>
<div class="org-src-container">
<pre class="src src-R">fit.11 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (switch ~ dist100 + arsenic + educ4 + dist100:arsenic,
               family=binomial(link=<span style="color: #2d9574;">"logit"</span>))
summary(fit.11)
</pre>
</div>

<pre class="example">

Call:
glm(formula = switch ~ dist100
arsenic
educ4
dist100:arsenic, 
    family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7149  -1.1886   0.7478   1.0689   1.7223  

Coefficients:
                Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)     -0.34904    0.12636  -2.762  0.00574 ** 
dist100         -0.60470    0.20949  -2.886  0.00390 ** 
arsenic          0.55537    0.06953   7.987 1.38e-15 ***
educ4            0.16922    0.03833   4.415 1.01e-05 ***
dist100:arsenic -0.16291    0.10235  -1.592  0.11145    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 4118.1  on 3019  degrees of freedom
Residual deviance: 3907.9  on 3015  degrees of freedom
AIC: 3917.9

Number of Fisher Scoring iterations: 4
</pre>

<div class="org-src-container">
<pre class="src src-R">b <span style="color: #ce537a; font-weight: bold;">&lt;-</span> coef (fit.11); hi <span style="color: #ce537a; font-weight: bold;">&lt;-</span> 1; lo <span style="color: #ce537a; font-weight: bold;">&lt;-</span> 0
delta <span style="color: #ce537a; font-weight: bold;">&lt;-</span> invlogit (b[1] + b[2]*hi + b[3]*arsenic +b[4]*educ4 +b[5]*hi*arsenic) -
invlogit (b[1] + b[2]*lo + b[3]*arsenic + b[4]*educ4 +b[5]*lo*arsenic)
print (mean(delta))
<span style="color: #4f97d7;">detach</span>(wells)
</pre>
</div>

<pre class="example">

[1] -0.1944495

</pre>
</div>
</div>

<div id="outline-container-org1de05b9" class="outline-3">
<h3 id="org1de05b9"><span class="section-number-3">1.10</span> 识别与分离</h3>
<div class="outline-text-3" id="text-1-10">
<ol class="org-ol">
<li>共线性引起的识别问题，可以采取与线性回归相同的方法解决</li>

<li>分离引起的识别问题：
<ul class="org-ul">
<li>某个预测变量 \(x_j\) 与结果的取值完全对应，当 \(x_j\) 大于某个阈值 \(T\) ，所有的 \(y=1\) ；而当 \(x_j\) 小于阈值 \(T\) 的时候，所有的 \(y=1\) ，此时系数 \(\beta_j\) 的最佳估计为 \(\infty\)</li>
<li>反之，如果对于 \(x_j < T\)，所有的 \(y=1\) ，而对于 \(x_j>T\) ，所有的 \(y=0\) ，那么 \(\hat \beta_j=-\infty\)</li>
<li>一般会是自变量的某个线性组合与结果完全对应，会导致至少线性组合中某个自变量的系数估计值为 \(\infty 或者 -\infty\)</li>
</ul></li>
</ol>
<div class="org-src-container">
<pre class="src src-R">x <span style="color: #ce537a; font-weight: bold;">&lt;-</span> rnorm(60, mean =1, sd = 2)
y <span style="color: #ce537a; font-weight: bold;">&lt;-</span> ifelse(x&lt;2,0,1)
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">Fit the model</span>

fit.0 <span style="color: #ce537a; font-weight: bold;">&lt;-</span> glm (y ~ x, family=binomial(link=<span style="color: #2d9574;">"logit"</span>))

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">Plot</span>

plot (x, y, xlab=<span style="color: #2d9574;">"x"</span>, ylab=<span style="color: #2d9574;">"y"</span>, xlim=c(-6,6), pch=20)
curve (invlogit (coef(fit.0)[1] + coef(fit.0)[2]*x), add=<span style="color: #a45bad;">TRUE</span>)
</pre>
</div>


<div class="figure">
<p><img src="separation.png" alt="separation.png" />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: 厦门大学公共事务学院</p>
<p class="date">Created: 2019-07-11 四 16:56</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
